name: Windows Build (MSYS2 MinGW, Qt6 + OpenCV)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # MSYS2 (UCRT64) + Qt6 + OpenCV + orodja
      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          release: true
          update: true
          msystem: UCRT64
          install: >
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-qt6-base
            mingw-w64-ucrt-x86_64-qt6-tools
            mingw-w64-ucrt-x86_64-opencv
            mingw-w64-ucrt-x86_64-ffmpeg
            zip

      # Konfiguracija: Qt je v /ucrt64, OpenCV config v /ucrt64/lib/cmake/opencv4
      - name: Configure (CMake + Ninja)
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=/ucrt64 \
            -DOpenCV_DIR=/ucrt64/lib/cmake/opencv4

      - name: Build
        shell: msys2 {0}
        run: cmake --build build --config Release --parallel

      # Zanesljivo poiščemo PRAVI .exe (ne CMake test a.exe)
      - name: Find EXE
        id: findexe
        shell: msys2 {0}
        run: |
          set -e
          echo "---- Kandidati .exe v build/ ----"
          find build -type f -name "*.exe" -not -path "*/CMakeFiles/*" -not -path "*/Testing/*" -print || true

          # 1) poskusi ujeti pravi naziv (najpogosteje LiveVideoMagnification.exe)
          EXE=$(find build -type f -name "*Live*Video*Magnification*.exe" -not -path "*/CMakeFiles/*" -print | head -n1)

          # 2) če ga ni, vzemi NAJVEČJI .exe (izloči a.exe ipd.)
          if [ -z "$EXE" ]; then
            CANDS=$(find build -type f -name "*.exe" -not -path "*/CMakeFiles/*" -not -path "*/Testing/*" -not -name "a.exe")
            if [ -n "$CANDS" ]; then
              EXE=$(for f in $CANDS; do echo $(stat -c%s "$f")" "$f; done | sort -nr | head -n1 | awk '{print $2}')
            fi
          fi

          if [ -z "$EXE" ]; then
            echo "No .exe produced"; exit 1
          fi

          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Found EXE: $EXE"

      # Zberemo Qt runtime za NAŠ EXE
      - name: Bundle Qt runtimes
        shell: msys2 {0}
        run: |
          EXE_WIN=$(cygpath -w "$EXE")
          echo "windeployqt-qt6 -> $EXE_WIN"
          windeployqt-qt6 --release "$EXE_WIN"

      # Skopiramo OpenCV + FFmpeg + MinGW DLL-je, da bo paket "portable"
      - name: Copy OpenCV + MinGW runtimes
        shell: msys2 {0}
        run: |
          BIN_DIR=$(dirname "$EXE")
          # OpenCV
          cp /ucrt64/bin/libopencv*.dll "$BIN_DIR"/
          # FFmpeg (za video I/O)
          cp /ucrt64/bin/avcodec-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/avformat-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/avutil-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/swscale-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/swresample-*.dll "$BIN_DIR"/ || true
          # MinGW runtime
          cp /ucrt64/bin/libstdc++-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgcc_s_*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libwinpthread-*.dll "$BIN_DIR"/ || true

      # Spakiramo v ZIP (Windows pot za upload)
      - name: Package ZIP
        shell: msys2 {0}
        run: |
          BIN_DIR=$(dirname "$EXE")
          cd "$BIN_DIR"/..
          ZIP="$RUNNER_TEMP/LiveVideoMagnification-msys2.zip"
          zip -r "$ZIP" "$(basename "$BIN_DIR")"
          ZIP_WIN=$(cygpath -w "$ZIP")
          echo "ZIP_WIN=$ZIP_WIN" >> $GITHUB_ENV
          echo "Packaged $ZIP_WIN"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LiveVideoMagnification-msys2
          path: ${{ env.ZIP_WIN }}
