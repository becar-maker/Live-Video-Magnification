name: Windows Build (Qt6 + prebuilt OpenCV)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # Qt 6 z MSVC 2022; aqt pin na stabilno verzijo
      - name: Install Qt (MSVC 2022)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.3'             # LTS, zanesljiva
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          cache: true
          aqtversion: '==3.2.0'        # pomembno: izogni se 3.3.0 te≈æavi

      - name: Install tools
        shell: pwsh
        run: choco install -y ninja 7zip

      # Prenesi uradni prebuilt OpenCV 4.10 (SFX .exe) in ga razpakiraj
      - name: Get prebuilt OpenCV 4.10
        shell: pwsh
        run: |
          $ov = '4.10.0'
          $exe = Join-Path $env:RUNNER_TEMP "opencv-$ov-windows.exe"
          Invoke-WebRequest "https://github.com/opencv/opencv/releases/download/$ov/opencv-$ov-windows.exe" -OutFile $exe
          7z x $exe -oC:\ -y
          dir C:\opencv\build

      - name: Configure (CMake + Ninja)
        shell: pwsh
        run: |
          $ocvRoot = 'C:\opencv\build'
          $binVC17 = 'C:\opencv\build\x64\vc17\bin'
          $binVC16 = 'C:\opencv\build\x64\vc16\bin'
          if (Test-Path $binVC17) { $env:OCV_BIN = $binVC17 } else { $env:OCV_BIN = $binVC16 }
          cmake -S . -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DOpenCV_DIR="$ocvRoot" `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"

      - name: Build
        shell: pwsh
        run: cmake --build build --config Release --parallel

      - name: Locate EXE
        id: findexe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path build -Recurse -Filter *.exe |
            Where-Object { $_.Name -notmatch 'cmake|ctest' } |
            Select-Object -First 1
          if (-not $exe) { throw "EXE not found" }
          "EXE=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Found $($exe.FullName)"

      - name: Bundle Qt (windeployqt)
        shell: pwsh
        run: |
          & "$env:Qt6_DIR\bin\windeployqt.exe" --release --compiler-runtime "$env:EXE"

      - name: Copy OpenCV DLLs (prebuilt)
        shell: pwsh
        run: |
          $bindir = Split-Path $env:EXE
          Copy-Item "$env:OCV_BIN\*.dll" $bindir -Force

      - name: Package ZIP
        shell: pwsh
        run: |
          $bindir = Split-Path $env:EXE
          $zip = Join-Path $env:RUNNER_TEMP "LiveVideoMagnification-win64.zip"
          Push-Location $bindir
          7z a $zip *
          Pop-Location
          "ZIP=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LiveVideoMagnification-win64
          path: ${{ env.ZIP }}
