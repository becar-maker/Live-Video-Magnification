name: Windows Build (MSYS2 MinGW, Qt6 + OpenCV, full bundle)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up MSYS2 (UCRT64) + all deps
        uses: msys2/setup-msys2@v2
        with:
          release: true
          update: true
          msystem: UCRT64
          install: >
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-qt6-base
            mingw-w64-ucrt-x86_64-qt6-tools
            mingw-w64-ucrt-x86_64-opencv
            mingw-w64-ucrt-x86_64-ffmpeg
            mingw-w64-ucrt-x86_64-tbb
            mingw-w64-ucrt-x86_64-zlib
            mingw-w64-ucrt-x86_64-freetype
            mingw-w64-ucrt-x86_64-harfbuzz
            mingw-w64-ucrt-x86_64-brotli
            mingw-w64-ucrt-x86_64-libpng
            mingw-w64-ucrt-x86_64-bzip2
            mingw-w64-ucrt-x86_64-zstd
            mingw-w64-ucrt-x86_64-double-conversion
            mingw-w64-ucrt-x86_64-libb2
            mingw-w64-ucrt-x86_64-graphite2
            mingw-w64-ucrt-x86_64-fribidi
            # GLib + GStreamer (da bo delovalo tudi, če se nalagata)
            mingw-w64-ucrt-x86_64-glib2
            mingw-w64-ucrt-x86_64-gstreamer
            mingw-w64-ucrt-x86_64-gst-plugins-base
            mingw-w64-ucrt-x86_64-gst-plugins-good
            mingw-w64-ucrt-x86_64-libiconv
            mingw-w64-ucrt-x86_64-gettext
            mingw-w64-ucrt-x86_64-ntldd-git
            zip

      - name: Configure (CMake + Ninja)
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=/ucrt64 \
            -DOpenCV_DIR=/ucrt64/lib/cmake/opencv4 \
            -DCMAKE_RUNTIME_OUTPUT_DIRECTORY=$(pwd)/build/bin

      - name: Build
        shell: msys2 {0}
        run: cmake --build build --config Release --parallel

      - name: Find EXE
        id: findexe
        shell: msys2 {0}
        run: |
          set -euo pipefail
          shopt -s nullglob
          candidates=()
          [ -d build/bin ] && while IFS= read -r -d '' f; do candidates+=("$f"); done < <(find build/bin -maxdepth 1 -type f -name "*.exe" -print0)
          if [ ${#candidates[@]} -eq 0 ]; then
            while IFS= read -r -d '' f; do candidates+=("$f"); done < <(find build -type f -name "*.exe" ! -path "*/CMakeFiles/*" ! -name "a.exe" -print0)
          fi
          [ ${#candidates[@]} -eq 0 ] && { echo "No .exe produced"; exit 1; }
          max=0; exe=""
          for f in "${candidates[@]}"; do s=$(stat -c%s "$f"); (( s>max )) && { max=$s; exe="$f"; }; done
          echo "EXE=$exe" >> $GITHUB_ENV
          echo "Found EXE: $exe"

      - name: Bundle Qt runtimes (windeployqt)
        shell: msys2 {0}
        run: |
          EXE_WIN=$(cygpath -w "$EXE")
          windeployqt-qt6 --release "$EXE_WIN"

      # Kritične DLL + “kitchen-sink” set (tbb, zlib, freetype, harfbuzz, GLib, GStreamer, …)
      - name: Copy runtime DLLs (curated set)
        shell: msys2 {0}
        run: |
          BIN_DIR=$(dirname "$EXE")
          # OpenCV + FFmpeg
          cp /ucrt64/bin/libopencv*.dll "$BIN_DIR"/
          cp /ucrt64/bin/avcodec-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/avformat-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/avutil-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/swscale-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/swresample-*.dll "$BIN_DIR"/ || true
          # TBB, zlib, freetype, harfbuzz, grafika/pisave
          for n in libtbb12.dll tbb12.dll; do [ -f /ucrt64/bin/$n ] && cp /ucrt64/bin/$n "$BIN_DIR"/; done
          cp /ucrt64/bin/zlib1.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libfreetype-6.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libharfbuzz-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libbrotli*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libpng16-16.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libbz2-1.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libzstd*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgraphite2.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libfribidi-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libb2-1.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libdouble-conversion.dll "$BIN_DIR"/ || true
          # GLib / GStreamer
          cp /ucrt64/bin/libglib-2.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgobject-2.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgio-2.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libintl-8.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libiconv-2.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libpcre2-8-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libffi-8.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgstreamer-1.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgstbase-1.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgstapp-1.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgstaudio-1.0-0.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgstvideo-1.0-0.dll "$BIN_DIR"/ || true
          # MinGW runtime
          cp /ucrt64/bin/libstdc++-*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libgcc_s_*.dll "$BIN_DIR"/ || true
          cp /ucrt64/bin/libwinpthread-*.dll "$BIN_DIR"/ || true

      # Samodejni sweep: EXE + vsi DLL + vsi Qt plugin-i → kopiraj vsako odvisnost iz /ucrt64/bin
      - name: Auto-bundle remaining deps (ntldd sweep)
        shell: msys2 {0}
        run: |
          set -euo pipefail
          BIN_DIR=$(dirname "$EXE")
          list_deps() { ntldd -R "$1" | awk '/=>/ && $3 ~ /^\/ucrt64\/bin\// {print $3}'; }
          tmp=$(mktemp)
          find "$BIN_DIR" -maxdepth 1 -type f \( -name "*.exe" -o -name "*.dll" \) -print0 | \
            xargs -0 -I{} bash -lc 'list_deps "{}"' >> "$tmp" || true
          [ -d "$BIN_DIR/plugins" ] && find "$BIN_DIR/plugins" -type f -name "*.dll" -print0 | \
            xargs -0 -I{} bash -lc 'list_deps "{}"' >> "$tmp" || true
          sort -u "$tmp" | while read -r d; do cp -n "$d" "$BIN_DIR"/ || true; done
          rm -f "$tmp"

      # Hitra verifikacija: ključne 4 DLL morajo obstajati
      - name: Verify key DLLs present
        shell: msys2 {0}
        run: |
          BIN_DIR=$(dirname "$EXE")
          for f in libtbb12.dll zlib1.dll libfreetype-6.dll libharfbuzz-0.dll libglib-2.0-0.dll libgobject-2.0-0.dll libgstapp-1.0-0.dll libgstaudio-1.0-0.dll; do
            [ -f "$BIN_DIR/$f" ] || { echo "MISSING: $f"; exit 1; }
          done
          echo "All key DLLs found."

      - name: Package ZIP
        shell: msys2 {0}
        run: |
          BIN_DIR=$(dirname "$EXE")
          cd "$BIN_DIR"/..
          ZIP="$RUNNER_TEMP/LiveVideoMagnification-msys2.zip"
          zip -r "$ZIP" "$(basename "$BIN_DIR")"
          echo "ZIP_WIN=$(cygpath -w "$ZIP")" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LiveVideoMagnification-msys2
          path: ${{ env.ZIP_WIN }}
